<!DOCTYPE html>
<html>
  <meta name="apple-mobile-web-app-title" content="CoffeeLogger">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#D1B888">
  <meta name="viewport" content="width=device-width">
  <link rel="apple-touch-icon" href="icon.png">
  <head>
<style>
* {
    box-sizing: border-box;
    font-family: system-ui, iconMode;
}
body {
  margin:0;
  background-color: #D1B888;
/*  background: linear-gradient(0deg, rgba(62,86,131,1) 0%, rgba(81,142,186,1) 100%);*/
  text-align: right;
  touch-action: none;
  background-attachment: fixed;
  height: 100vh;
  overflow:hidden;
}

#roundedCorners1, #roundedCorners2 {
  border: none;
  border-radius: 15px;
  overflow: scroll;
  width: 96%;
  max-height: 69.5vw;
  margin-right: 2%;
  margin-left: 2%;
  margin-bottom: 3vw;
  box-shadow: 0px 0px 12px -2px #00000020;
}

.grinders {
  font-weight: light;
  font-size: 6vw;
  text-align: left;
  margin-bottom: 3vw;
  margin-left: 3vw;
}

table {
  border-collapse: collapse;
  width: 100%;
  text-align: center;
}

thead tr {
  position: sticky;
  top: 0;
  background-color: #ffffff90;
  font-size: 5vw;
  border: none;
  -webkit-backdrop-filter: blur(35px);
  backdrop-filter: blur(35px);
  height: 10vw;

}
tbody {
  font-weight: light;
  font-size: 3.5vw;
}
td {
    padding: 4pt;
    width: 25vw;
    border: none;
    height: 9vw;
}

tbody tr:nth-child(even) {
  background-color: #ffffff50;
}
tbody tr:nth-child(odd) {
  background-color: #ffffff30;
}
tbody td:nth-child(-n+2) {
  font-size: 3.3vw;
}
.dark-theme {
  background-color: #282828;
  color: #bbbbbb;
}
.dark-theme caption {
  color: #999999;
}
.dark-theme td {
    border: solid 1pt #bbbbbb60;
}
.dark-theme tbody tr:nth-child(even) {
    background-color: #3d3d3d;
}
.dark-theme tbody tr:nth-child(odd) {
  background-color: #22222250;
}
.dark-theme thead {
    border: solid 1pt #bbbbbb60;
    background-color: #3d3d3d;
}
.dark-theme button,
.dark-theme #logDetails,
.dark-theme #idTime,
.dark-theme #resetButton,
.dark-theme #selectList {
  background-color: #3d3d3d;
  color: #bbbbbb;
}
.dark-theme .form-container {
   background-color: #ffffff20;
}
.dark-theme #logDetails:focus,
.dark-theme #idTime:focus,
.dark-theme #selectList:focus {
  -webkit-backdrop-filter: blur(35px);
  background-color: #11111160;
  outline: none;
}
.dark-theme #title {
  color: #ffffffbb;
}
.dark-theme #inputIcon {
  color: #ffffffcc;
}
          
/* The popup form - hidden by default */
button {
  font-size: 5.5vw;
  padding:1.5vw;
  color: black;
  background-color: #ffffff50;
  border: none;
  border-radius: 10px;
  text-align: center;
  margin-right: 2vw;
  -webkit-backdrop-filter: blur(55px);
  backdrop-filter: blur(55px);
}

#resetButton {
  margin-left: auto;
}

#menuButton {
  z-index: 999;
  padding: 2.5vw;
  right: 6vw;
  margin-top: 2vh;
  margin-bottom: 2vh;
  box-shadow: 0px 0px 12px -2px #00000020;
}

#addBrew {
  position: fixed;
  bottom: 10vh;
  right: 4vw;
  padding: 3vw;
  box-shadow: 0px 0px 40px 30px #00000010;
}

input, select{
  padding-left: 4vw;
}

::placeholder {
  color: #00000090; 
  font-size: 5vw;
  opacity: 0.55;
}

.form-popup {
  display: none;
  position: fixed;
  top: 0px;
  left: 0px;
  padding: 0;
  border: none;
  background-color: #ffffff20;
  -webkit-backdrop-filter: blur(25px);
  backdrop-filter: blur(25px);
  width: 100vw;
  height:100vh;
}

/* Add styles to the form container */
.form-container {
 width: 90vw;
 left: 5vw;
 top: 10vw;
 position: fixed;
 background-color: #70707030;
 -webkit-backdrop-filter: blur(30px);
 backdrop-filter: blur(30px);
 border-radius: 15px;
 padding: 4vw;
}

#title {
  font-size: 10vw;
  font-weight: bold;
}
/* input fields()*/ 
#logDetails,
#idTime,
#selectList {
  width: 70vw;
  height: 14vw;
  border: none;
  border-radius: 15px;
  background-color: #ffffff50;
  font-size: 5vw;
  color: black;
  margin-left: auto;
}
#selectList {
  appearance: none;
}
/* When the inputs get focus, do something */
#logDetails:focus,
#idTime:focus,
#selectList:focus {
  -webkit-backdrop-filter: blur(35px);
  background-color: #ffffff85;
  outline: none;
}
#resetButton {
  height: 12vw;
  width: 20vw;
  text-align: center;
  font-size: 4vw;
  color: black;
  background-color: #ffffff40;
 -webkit-backdrop-filter: blur(15px);
  border: none;
  border-radius: 15px;
}
#inputIcon {
  font-size: 8vw;
  display: flex;
  justify-content: center;
  align-items: center;
}

#firstRow, #secondRow, #thirdRow {
      vertical-align: middle;
      justify-content: space-evenly;
      display: flex;
      padding:0;
      margin-bottom: 3vw;
}
#buttonRow, #headRow {
  justify-content: space-between;
  display: flex;
}
#headRow {
  height: 15vw;
  margin-left: 0vw;
}
#closeButton {
  margin-left: 3vw;
  margin-right: 0vw;
}

#popupBackground {
  background-color: #ffffff10;
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(5px);
  display: none;
  position: fixed;
  top:0px;
  left: 0px;
  width: 100vw;
  height: 100vh;
  z-index: 999;
}

#popup {
  position: fixed;
  top: 20vh;
  width: 80vw;
  background: #00000030;
  -webkit-backdrop-filter: blur(55px);
  backdrop-filter: blur(55px);
  /*box-shadow: 0px 0px 150vw 150vw #000000bb;*/
  border: none;
  padding: 5%;
  border-radius: 5vw;
  display: none;
  left: 10%;
}

#menu-form input, #menu-form button {
  height: 8vh;  
  border: none;
  outline: none;
  background-color: #ffffff70;
  border-radius: 3.5vw;
  font-size: 5vw;
}

#menu-form button {
  padding: 5pt;
  width: 31%;
}

#menu-form input {
  width: 100%;
  margin-bottom: 3.2%;
  text-align: left;
  padding-left: 4vw;
}

#menu-form input:focus {
  background-color: #ffffffaa;
}


#popBtnContainer {
  display: flex;
  justify-content: space-between;
  margin-left: auto;
  margin-right: auto;
}

#popInpContainer {
  justify-content: space-evenly;
  margin-left: auto;
  margin-right: auto;
}
/* ======== ANIMATIONS ====== */

.fade-bg-in {
  animation: fade-in 0.45s ease;
}
.fade-bg-out {
  animation: fade-out 0.25s ease;
}

.slide-out-blurred-top {
animation: slide-out-blurred-top 0.25s cubic-bezier(0.755, 0.050, 0.855, 0.060) both;
}

.slide-in-blurred-top {
animation: slide-in-blurred-top 0.25s cubic-bezier(0.230, 1.000, 0.320, 1.000) both;
}

@-webkit-keyframes slide-in-blurred-top {
  0% {
    -webkit-transform: translateY(-1000px) scaleY(2.5) scaleX(0.2);
            transform: translateY(-1000px) scaleY(2.5) scaleX(0.2);
    -webkit-transform-origin: 50% 0%;
            transform-origin: 50% 0%;
    -webkit-filter: blur(40px);
            filter: blur(40px);
    opacity: 0;
  }
  100% {
    -webkit-transform: translateY(0) scaleY(1) scaleX(1);
            transform: translateY(0) scaleY(1) scaleX(1);
    -webkit-transform-origin: 50% 50%;
            transform-origin: 50% 50%;
    -webkit-filter: blur(0);
            filter: blur(0);
    opacity: 1;
  }
}
@keyframes slide-in-blurred-top {
  0% {
    -webkit-transform: translateY(-1000px) scaleY(2.5) scaleX(0.2);
            transform: translateY(-1000px) scaleY(2.5) scaleX(0.2);
    -webkit-transform-origin: 50% 0%;
            transform-origin: 50% 0%;
    -webkit-filter: blur(40px);
            filter: blur(40px);
    opacity: 0;
  }
  100% {
    -webkit-transform: translateY(0) scaleY(1) scaleX(1);
            transform: translateY(0) scaleY(1) scaleX(1);
    -webkit-transform-origin: 50% 50%;
            transform-origin: 50% 50%;
    -webkit-filter: blur(0);
            filter: blur(0);
    opacity: 1;
  }
}

@-webkit-keyframes slide-out-blurred-top {
  0% {
    -webkit-transform: translateY(0) scaleY(1) scaleX(1);
            transform: translateY(0) scaleY(1) scaleX(1);
    -webkit-transform-origin: 50% 0%;
            transform-origin: 50% 0%;
    -webkit-filter: blur(0);
            filter: blur(0);
    opacity: 1;
  }
  100% {
    -webkit-transform: translateY(-1000px) scaleY(2) scaleX(0.2);
            transform: translateY(-1000px) scaleY(2) scaleX(0.2);
    -webkit-transform-origin: 50% 0%;
            transform-origin: 50% 0%;
    -webkit-filter: blur(40px);
            filter: blur(40px);
    opacity: 0;
  }
}
@keyframes slide-out-blurred-top {
  0% {
    -webkit-transform: translateY(0) scaleY(1) scaleX(1);
            transform: translateY(0) scaleY(1) scaleX(1);
    -webkit-transform-origin: 50% 0%;
            transform-origin: 50% 0%;
    -webkit-filter: blur(0);
            filter: blur(0);
    opacity: 1;
  }
  100% {
    -webkit-transform: translateY(-1000px) scaleY(2) scaleX(0.2);
            transform: translateY(-1000px) scaleY(2) scaleX(0.2);
    -webkit-transform-origin: 50% 0%;
            transform-origin: 50% 0%;
    -webkit-filter: blur(40px);
            filter: blur(40px);
    opacity: 0;
  }
}
@keyframes fade-out {
  0% {
    opacity: 1;
  }
  100% {
    opacity: 0;
  }
}
@keyframes fade-in {
  0% {
    opacity: 0;
  }
  100% {
    opacity: 1;
  }
}

/* ======== ANIMATIONS END ====== */

</style>
</head>
<body>
<button id="menuButton" onclick="showPopup()">&#x100306;</button>
<div id="popupBackground">
<div id="popup">
  <form id="menu-form">
    <div id="popInpContainer">
      <input type="text" placeholder="First Grinder" name="firstGrinder" id="formInput1">
        <input type="text" placeholder="Second Grinder" name="secondGrinder" id="formInput2">
      <input type="text" placeholder="Enter IFTTT Key" name="iftttKeyInput" id="formInput3">
    </div>
    <div id=popBtnContainer>
      <button onclick="clearLocalStorage()" id="csvBtn">Wipe Data</button>
      <button onclick="openCsvOrFont()" id="fontBtn">Add File</button>
      <button type="submit" id="saveButton">Save</button>
    </div>
  </form>
</div>
</div>

<div id="grinder1Title" class="grinders">Grinder 1</div>
<div id="roundedCorners1">
  <table id="grinder1">
    <thead id="tableHead1">
      <tr>
              <td>&#x100249;</td>
              <td>&#x10042b;</td> 
              <td>&#x1007f2;</td>
              <td>&#x100b6d;</td> 
              <td>&#x101384;</td>
              <td>&#x1001ec;</td> 
              <td>&#x10155c;</td>
              <td>&#x1002c4;</td> 
              <td>&#x10042f;</td>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>

<!-- <button id="toggleB1" onclick="toggleTable1();toggleSlice1()">&#x100068;</button> -->
<button id="addBrew" onclick="openForm()">&#x1003c7;</button>

<div class="grinders" id="grinder2Title">Grinder 2</div>
<div id="roundedCorners2">
  <table id="grinder2">
    <thead id="tableHead2">
      <tr>
              <td>&#x100249;</td>
              <td>&#x10042b;</td> 
              <td>&#x1013b4;</td>
              <td>&#x100b6d;</td> 
              <td>&#x101384;</td>
              <td>&#x1001ec;</td> 
              <td>&#x10155c;</td>
              <td>&#x1002c4;</td> 
              <td>&#x10042f;</td>
      </tr>
    </thead>
      <tbody>
    </tbody>
  </table>
</div>

<!-- <button id="toggleB2" onclick="toggleTable2();toggleSlice2()">&#x100068;</button> -->
 
<div class="form-popup" id="myForm">
  <form action="/action_page.php" class="form-container" autocomplete="off" novalidate>

<div id="headRow">
<div id=title>Brew Logger</div>
</div>

<div id="firstRow">
  <div id="inputIcon">&#x1007f2;</div>
  <input type="text" autocorrect="off" autocapitalize="off" placeholder="Enter measurements" name="log" id="logDetails">
</div>

<div id="secondRow">
  <div id="inputIcon">&#x10155c;</div>
  <select name="recipe" id="selectList" required>
    <optgroup label="Inverted">
      <option value="TWi">Wendelboe inverted</option>
      <option value="JHi">Hoffmann inverted</option>
      <option value="OXi">Onyx inverted</option>
    </optgroup>
    <optgroup label="Aeropress">
      <option value="JH">James Hoffmann</option>
      <option value="TW">Tim Wendelboe</option>
      <option value="OX">Onyx Coffee</option>
    </optgroup>
    <optgroup label="V60">
      <option value="TK">Tetsu Kasuya 4:6</option>
      <option value="OX">Onyx Coffee</option>
      <option value="JH">James Hoffmann</option>
    </optgroup>
    <optgroup label="Moka Pot">
      <option value="MK">James Hoffmann</option>
    </optgroup>
  </select>
</div>

<div id="thirdRow">
  <div id="inputIcon">&#x10042f;</div>
  <input type="number" placeholder="Enter time" name="time" id="idTime">
</div>
    
<div id=buttonRow>
    <input type=reset value="&#x100060;" id="resetButton"></input>
    <button type="button" onclick="closeForm();closeFormEval()" id="closeButton">Close</button>
      </div>
    </form>
  </div>

<script>
window.addEventListener('beforeunload', () => {
    saveDataToLocalStorage("#grinder1 tbody tr", "coffeeLog1");
    saveDataToLocalStorage("#grinder2 tbody tr", "coffeeLog2");
});

document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden') {
    saveDataToLocalStorage("#grinder1 tbody tr", "coffeeLog1");
    saveDataToLocalStorage("#grinder2 tbody tr", "coffeeLog2");
  }
});

function saveDataToLocalStorage(userGrinder, userLog) {
  const rows = document.querySelectorAll(userGrinder);
  const data = [];
  rows.forEach((row) => {
    const cells = row.querySelectorAll('td');
    const rowData = {
      date: cells[0].innerHTML,
      time: cells[1].innerHTML,
      setting: cells[2].innerHTML,
      gr: cells[3].innerHTML,
      ml: cells[4].innerHTML,
      degrees: cells[5].innerHTML,
      recipe: cells[6].innerHTML,
      rating: cells[7].innerHTML,
      drawdown: cells[8].innerHTML,
    };
    data.push(rowData);
  });
  localStorage.setItem(userLog, JSON.stringify(data));
}


function loadSelectedFont() {
  const fontData = localStorage.getItem('selectedFont');
  if (fontData) {
    // const tableHeaders = document.querySelectorAll('thead tr td');
    // const tableHeaderCell = document.querySelector('thead tr td');
    // if (tableHeaders.length > 0) {
    //   tableHeaders[0].style.fontSize = "3vw";
    //   tableHeaders[1].style.fontSize = "3vw";
    //   tableHeaders[2].style.fontSize = "3vw";
    //   tableHeaders[0].textContent = '\u{100249}';
    //   tableHeaders[1].textContent = '\u{10042b}';
    //   tableHeaders[2].textContent = '\u{101384}';
    // }
    // const menuButtonIcon = document.querySelector('#menuButton')
    //   menuButtonIcon.style.fontSize = "3.5vw";
    //   menuButtonIcon.textContent = '\u{100306}';
      const css = `@font-face {
      font-family: 'iconMode';
      src: url('data:font/opentype;charset=utf-8;base64,${fontData}');
      font-display: swap;
    }`;
    const style = document.createElement('style');
    style.appendChild(document.createTextNode(css));
    document.head.appendChild(style);
  }
}

window.addEventListener('load', () => {
  loadSelectedFont()

  window.setTimeout(() => {

    loadLogs('coffeeLog1', '#grinder1 tbody');
    loadLogs('coffeeLog2', '#grinder2 tbody');

    const grinderTitle1 = localStorage.getItem('grinderName1')
    if (grinderTitle1) {
      document.querySelector('#grinder1Title').textContent = grinderTitle1
      document.querySelector('#formInput1').setAttribute('placeholder', 'Current: ' + grinderTitle1)
    }
    const grinderTitle2 = localStorage.getItem('grinderName2')
    if (grinderTitle2) {
      document.querySelector('#grinder2Title').textContent = grinderTitle2
      document.querySelector('#formInput2').setAttribute('placeholder', 'Current: ' + grinderTitle2)
    }
    if (!localStorage.getItem('iftttKey')){} else {
      const popupIftttInput = document.getElementById('formInput2')
      popupIftttInput.setAttribute('placeholder', 'IFTTT key found')
    }
  }, 10);
});


function loadLogs(userGrinder, selectedTable) {
  const data = JSON.parse(localStorage.getItem(userGrinder));
  const tableBody = document.querySelector(selectedTable);
  if (data) {
  // iterate through the data array from beginning to end
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const tableRow = document.createElement('tr');
      const dateCell = document.createElement('td');
      dateCell.textContent = row.date;
      const timeCell = document.createElement('td');
      timeCell.textContent = row.time;
      const setCell = document.createElement('td');
      setCell.textContent = row.setting;
      const grCell = document.createElement('td');
      grCell.textContent = row.gr;
      const mlCell = document.createElement('td');
      mlCell.textContent = row.ml;
      const degCell = document.createElement('td');
      degCell.textContent = row.degrees;
      const recCell = document.createElement('td');
      recCell.textContent = row.recipe;
      const ratCell = document.createElement('td');
      ratCell.textContent = row.rating;
      const drawCell = document.createElement('td');
      drawCell.textContent = row.drawdown;
      tableRow.appendChild(dateCell);
      tableRow.appendChild(timeCell);
      tableRow.appendChild(setCell);
      tableRow.appendChild(grCell);
      tableRow.appendChild(mlCell);
      tableRow.appendChild(degCell);
      tableRow.appendChild(recCell);
      tableRow.appendChild(ratCell);
      tableRow.appendChild(drawCell);
      tableBody.appendChild(tableRow);//, tableBody.firstChild); // use appendChild instead of insertBefore
    }
  }
}

const rowNumber = 8;
let useSlice1 = false;
let useSlice2 = false;

// function toggleTable1() {
//   if (useSlice1) {
//     while (tbody1.rows.length > rowNumber) {
//       tbody1.deleteRow(tbody1.rows.length - 1);
//     }
//   } else {
//     rows1.slice(rowNumber,).forEach((row) => {
//       const cells = row.trim().split(";");
//       const tr = tbody1.insertRow();
      
//   cells.forEach((cell, index) => {
//     const td = tr.insertCell();
//     td.textContent = cell;
//     if (index === 7) {
//       td.classList.add('rating-cell');
//      }
//     });
//    });
//   }
//   const button = document.getElementById('toggleB1');
//   if (button.textContent=== '\u{100066}') {
//     button.textContent = '\u{100068}';
//   } else {
//     button.textContent = '\u{100066}';
//   }
// }

// function toggleTable2() {
//   if (useSlice2) {
//     while (tbody2.rows.length > rowNumber) {
//       tbody2.deleteRow(tbody2.rows.length - 1);
//     }
//   } else {
//     rows2.slice(rowNumber,).forEach((row) => {
//       const cells = row.trim().split(";");
//       const tr = tbody2.insertRow();
      
//   cells.forEach((cell, index) => {
//     const td = tr.insertCell();
//     td.textContent = cell;
//     if (index === 7) {
//       td.classList.add('rating-cell');
//      }
//     });
//    });
//   }
//   const button = document.getElementById('toggleB2');
//   if (button.textContent=== '\u{100066}') {
//     button.textContent = '\u{100068}';
//   } else {
//     button.textContent = '\u{100066}';
//   }
// }

// function toggleSlice1() {
//   useSlice1 = !useSlice1;
// }
// function toggleSlice2() {
//   useSlice2 = !useSlice2;
// }

//initialTable();
    
// const body = document.querySelector('body');

// // Check if the system's color scheme is light or dark
// if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
//   body.classList.add('dark-theme');
// } else {
//   body.classList.remove('dark-theme');
// }

// // Add a listener to toggle the theme when the system's color scheme changes
// window.matchMedia('(prefers-color-scheme: dark)').addListener((event) => {
//   if (event.matches) {
//     body.classList.add('dark-theme');
//   } else {
//     body.classList.remove('dark-theme');
//   }
// }

// ===== Add brew form

const formPopup = document.getElementById("myForm")
const formContainer = formPopup.querySelector(".form-container");

function openForm() {
  formContainer.classList.add("slide-in-blurred-top");
  formPopup.classList.add("fade-bg-in")
  formPopup.style.display = "block";
  setTimeout(function() {
    formContainer.classList.remove("slide-in-blurred-top");
    formPopup.classList.remove("fade-bg-in");
  }, 300);
}


function closeForm() {
  formContainer.classList.add("slide-out-blurred-top");
  formPopup.classList.add("fade-bg-out");
  setTimeout(function() {
    formPopup.style.display = "none";
    formContainer.classList.remove("slide-out-blurred-top");
    formPopup.classList.remove("fade-bg-out");
  }, 250);
}

function closeFormEval() {
  const tbody1 = document.querySelector("#grinder1 tbody");
  const tbody2 = document.querySelector("#grinder2 tbody");
  const currentDate = new Date().toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: '2-digit' });
  const currentTime = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
  const logInput = document.getElementById("logDetails").value
  const logCells = logInput.replaceAll("-",";").split(";");
console.log("logInput: " + logInput)
  const selectList = document.getElementById("selectList").value;
  const idTime = document.getElementById("idTime").value.replace(".", ":");
  let tr;
  let rows;
  if (logInput.length>0) {
  if (logInput.includes(".")){
       tr = tbody1.insertRow(0);
       rows = tbody1.rows;
  } else {
       tr = tbody2.insertRow(0); 
       rows = tbody2.rows;
  }
    const cells = [currentDate, currentTime, logCells[0], logCells[1], logCells[2], logCells[3], selectList, "3", idTime];
    cells.forEach((cell, cellIndex) => {
      const td = tr.insertCell();
      td.textContent = cell;
      if (cellIndex === 7) {
        td.classList.add('rating-cell');
      }
      td.setAttribute('data-row', 0);
      td.setAttribute('data-col', cellIndex);
    });
    // adjust data-row and data-col for all cells in table body
    for (let rowIndex = 0; rowIndex < rows.length; rowIndex++) {
      const cells = rows[rowIndex].cells;
      for (let cellIndex = 0; cellIndex < cells.length; cellIndex++) {
        const cell = cells[cellIndex];
        cell.setAttribute('data-row', rowIndex);
        cell.setAttribute('data-col', cellIndex);
      }
    }
  }
}

// ====== END brew form

const ratingOptions = [1, 2, 3, 4, 5, 6];
const ratingPopup = document.createElement('div');
ratingPopup.setAttribute('id', 'rating-popup');
ratingPopup.style.display = 'none';
ratingPopup.style.justifyContent = 'center';
ratingPopup.style.fontWeight = 'light';
ratingPopup.style.position = 'fixed';
ratingPopup.style.top = '0';
ratingPopup.style.left = '0';
ratingPopup.style.width = '100vw';
ratingPopup.style.height = '100vh';
 ratingPopup.style.borderRadius = '30px';
 ratingPopup.style.padding = '20px';
ratingPopup.style.backgroundColor = '#f0f0f010';
ratingPopup.style.webkitBackdropFilter = 'blur(20px)';
ratingPopup.style.zIndex = '999';
ratingPopup.classList.add('fade-bg-in');

const ratingContainer = document.createElement('div');
ratingContainer.setAttribute('id', 'rating-container');
ratingContainer.style.position = 'fixed';
ratingContainer.style.top = '30vh';
ratingContainer.style.backgroundColor = '#00000030';
ratingContainer.style.borderRadius = '25px';
ratingContainer.style.webkitBackdropFilter = 'blur(35px)';
ratingContainer.classList.add('slide-in-blurred-top'); 

const ratingList = document.createElement('ul');
ratingList.style.display = 'flex';
ratingList.style.flexWrap = 'wrap';
ratingList.style.justifyContent = 'space-evenly';
ratingList.style.alignItems = 'center';
ratingList.style.marginTop = '26px';
ratingList.style.marginBottom = '22px';
ratingList.style.padding = '1vw';

const ratingItemSize = 11; // in vw units
const ratingItemMargin = 1; // in vw units
const ratingItemCountPerRow = Math.floor((85 - ratingItemMargin) / (ratingItemSize + ratingItemMargin)); // max count of items per row
const ratingItemWidth = ((85 - ratingItemMargin) / ratingItemCountPerRow) - ratingItemMargin; // calculate width based on max count and margin

ratingOptions.forEach(option => {
  const ratingItem = document.createElement('li');
  ratingItem.style.display = 'flex';
  ratingItem.style.justifyContent = 'center';
  ratingItem.style.alignItems = 'center';
  ratingItem.style.width = ratingItemWidth +'vw';
  ratingItem.style.height = ratingItemSize +'vw';
  ratingItem.style.margin = (ratingItemMargin / 2)+'vw';
  ratingItem.style.borderRadius = '25%';
  ratingItem.style.backgroundColor = '#ffffff60';
  ratingItem.style.webkitBackdropFilter = 'blur(25px)';
  ratingItem.style.fontSize = ratingItemSize-2 +'vw';
  ratingItem.style.color = 'black';
  ratingItem.style.cursor = 'pointer';
  ratingItem.innerText = option;
  ratingItem.addEventListener('click', function() {
    const selectedRating = this.innerText;
    const selectedCell = document.querySelector('.selected-cell');
    selectedCell.innerText = selectedRating;
    selectedCell.classList.remove('selected-cell');
    ratingPopup.classList.replace('fade-bg-in', 'fade-bg-out'); 
    ratingContainer.classList.replace('slide-in-blurred-top', 'slide-out-blurred-top'); 
    setTimeout(() => {
      ratingPopup.style.display = 'none';
      ratingPopup.classList.replace('fade-bg-out', 'fade-bg-in');
      ratingContainer.classList.replace('slide-out-blurred-top', 'slide-in-blurred-top');
    }, 250);
  });
  ratingList.appendChild(ratingItem);
});

const cancelButton = document.createElement('li');
cancelButton.style.display = 'flex';
cancelButton.style.justifyContent = 'center';
cancelButton.style.alignItems = 'center';
cancelButton.style.width = '11vw';
cancelButton.style.height = '11vw';
cancelButton.style.margin = '1vw';
cancelButton.style.borderRadius = '25%';
cancelButton.style.backgroundColor = '#ffffff60';
cancelButton.style.webkitBackdropFilter = 'blur(25px)';
cancelButton.style.fontSize = '6vw';
cancelButton.style.color = 'black';
cancelButton.style.cursor = 'pointer';
cancelButton.innerText = '\u{100060}';
cancelButton.addEventListener('click', function() {
    ratingPopup.classList.replace('fade-bg-in', 'fade-bg-out');
  ratingContainer.classList.replace('slide-in-blurred-top', 'slide-out-blurred-top'); 
    setTimeout(() => {
      ratingPopup.style.display = 'none';
      ratingPopup.classList.replace('fade-bg-out', 'fade-bg-in'); 
      ratingContainer.classList.replace('slide-out-blurred-top', 'slide-in-blurred-top');
    }, 250);
  });

ratingList.appendChild(cancelButton);
    ratingContainer.appendChild(ratingList);
    ratingPopup.appendChild(ratingContainer);
    document.body.appendChild(ratingPopup);

    const ratingCells = document.querySelectorAll('.rating-cell');
    ratingCells.forEach(cell => {
      cell.addEventListener('click', function() {
        const row = this.getAttribute('data-row');
        const col = this.getAttribute('data-col');
        const cellRect = this.getBoundingClientRect();
        ratingPopup.style.top = '0px';
        ratingPopup.style.left ='0px';
        ratingPopup.style.display = 'flex';
        ratingPopup.classList.add('active');
        this.classList.add('selected-cell');
      });
    });

// const tbodyEdit = document.querySelector('tbody');
// tbodyEdit.addEventListener('click', function(event) {
//   if (event.target.tagName === 'TR') {
//     const confirmDelete = confirm('Are you sure you want to delete this row?');
//     if (confirmDelete) {
//       event.target.remove();
//       const rowsU = document.querySelectorAll("tbody tr");
//       rowsU.forEach((line) => {
//         const cellsU = line.cells;
//         const rowDate = cellsU[0].textContent;
//         const rowTime = Number(cellsU[1].textContent.split(":")[0]);
//         if (rowDate === date && rowTime >= 2) {
//           updatedAmount += Number(cellsU[2].textContent);
//         }
//       });
//       document.getElementById("currentAmount").textContent = updatedAmount;
//     }
//   }
// });

// ========= popup =====
function showPopup() {
  const backgroundPopup = document.body.querySelector('#popupBackground')
  const popup = document.body.querySelector('#popup')
  var metaTag = document.querySelector('meta[name="theme-color"]');

  backgroundPopup.classList.add('fade-in');
  metaTag.setAttribute('content', '#D1B888');// add value for popup
  popup.classList.add('slide-in-blurred-top');
  backgroundPopup.style.display= 'block';
  popup.style.display= 'block';
  
  const form = document.getElementById('menu-form');
  form.addEventListener('submit', (event) => {
    event.preventDefault();
    const setGrinder1 = document.querySelector('[name="firstGrinder"]');
    if (setGrinder1.value!==""){
    localStorage.setItem('grinderName1',setGrinder1.value);
    }
    
    const setGrinder2 = document.querySelector('[name="secondGrinder"]');
    if (setGrinder2.value!==""){
    localStorage.setItem('grinderName2',setGrinder2.value);
    }
    const inputKey = document.querySelector('[name="iftttKeyInput"]');
    if (inputKey.value!==""){
    localStorage.setItem('iftttKey', inputKey.value);
    }

    backgroundPopup.classList.remove('fade-in');
    popup.classList.remove('slide-in-blurred-top');
    metaTag.setAttribute('content', '#D1B888');
    backgroundPopup.classList.add('fade-out');
    popup.classList.add('slide-out-blurred-top');
    
    setTimeout(() => {
      backgroundPopup.classList.remove('fade-out');
      popup.classList.remove('slide-out-blurred-top');
      backgroundPopup.style.display= 'none';
      popup.style.display= 'none';
    }, 200);
  });
}

function openCsvOrFont() {
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = '.csv,.ttf,.otf';
  fileInput.onchange = () => {
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = () => {
      const fileData = reader.result;
      if (file.type === 'text/csv') {
        addCsvToTable(fileData);
      } else if (file.type === 'font/ttf' || file.type === 'font/otf') {
        const reader = new FileReader();
        reader.onload = () => {
          const fontData = reader.result.split(',')[1];
          try {
            localStorage.setItem('selectedFont', fontData);
            alert('Selected font saved to local storage!');
          } catch (e) {
            alert('Error saving font to local storage: ' + e.message);
          }
        };
        reader.readAsDataURL(file);
      }
    };
    reader.readAsText(file);
  };
  fileInput.click();
}

function addCsvToTable(csvData) {
  const rows = csvData.split('\n').map(row => row.split(';'));
  rows.slice(0).forEach((row, rowIndex) => {
    const tr = tbody.insertRow();
    row.forEach((cell, cellIndex) => {
      const td = tr.insertCell();
      td.textContent = cell;
    });
  });
 // Store the CSV data in a global variable for later use
  window.csvWaterLog = csvData;
}

function checkStoredLog() {
  if (!localStorage.getItem('coffeeLog1')) {
    setTimeout(() => {
      showPopup();
      }, 250);
  }
}

function sendPostRequest(value, apiKey) {
  const script = document.createElement('script');
  const url = 'https://maker.ifttt.com/trigger/coffeeLogBackup/with/key/' + apiKey;
  script.src = `${url}?value1=${encodeURIComponent(value)}`;
  document.body.appendChild(script);
}

function clearLocalStorage() {
  localStorage.clear();
  const tbody = document.querySelector('tbody');
  tbody.innerHTML = '';
}

</script>
</body>
</html>
